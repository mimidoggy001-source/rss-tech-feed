name: Update RSS Feeds

on:
  # æ¯å¤©åŒ—äº¬æ—¶é—´ 09:00 è‡ªåŠ¨æ¨é€ï¼ˆ01:00 UTCï¼‰
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    # -----------------------
    # 1) æ‹‰å–ä»“åº“
    # -----------------------
    - name: Checkout repo
      uses: actions/checkout@v3

    # -----------------------
    # 2) Python ç¯å¢ƒ
    # -----------------------
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        pip install feedparser requests googletrans==4.0.0-rc1

    # -----------------------
    # 3) æŠ“å– RSS
    # -----------------------
    - name: Fetch RSS & Generate feeds.json
      run: |
        python <<EOF
        import feedparser, json

        rss_sources = [
            # ==== æµ·å¤–ç§‘æŠ€åª’ä½“ ====
            ("TechCrunch", "https://techcrunch.com/feed/"),
            ("The Verge", "https://www.theverge.com/rss/index.xml"),
            ("Engadget", "https://www.engadget.com/rss.xml"),
            ("Wired", "https://www.wired.com/feed/rss"),
            ("Ars Technica", "https://feeds.arstechnica.com/arstechnica/index/"),
            ("Bloomberg Tech", "https://feeds.bloomberg.com/technology/news.rss"),

            # ==== æ¸¸æˆ / æŒæœº ====
            ("IGN", "https://www.ign.com/rss"),
            ("GameSpot", "https://www.gamespot.com/feeds/mashup/"),
            ("Eurogamer", "https://www.eurogamer.net/?format=rss"),
            ("Kotaku", "https://kotaku.com/rss"),

            # ==== æ¶ˆè´¹ç”µå­ / æ‰‹æœº ====
            ("GSM Arena", "https://www.gsmarena.com/rss-news-reviews.php"),
            ("Android Authority", "https://www.androidauthority.com/feed/"),
            ("Notebook Check", "https://www.notebookcheck.net/RSS-Feed.8156.0.html"),
            ("Tomâ€™s Hardware", "https://www.tomshardware.com/feeds/all"),

            # ==== å›½å†…ç§‘æŠ€ ====
            ("ITHome", "https://www.ithome.com/rss/"),
            ("SSPai", "https://sspai.com/feed"),
            ("Leiphone", "https://www.leiphone.com/feed"),
        ]

        all_items = []

        for name, url in rss_sources:
            try:
                feed = feedparser.parse(url)
                for entry in feed.entries[:20]:
                    all_items.append({
                        "title": entry.get("title", ""),
                        "summary": entry.get("summary", "")[:500],
                        "url": entry.get("link", ""),
                        "platform": name,
                    })
            except Exception as e:
                print("âš  RSS æŠ“å–å¤±è´¥:", name, url, e)

        with open("feeds.json", "w", encoding="utf-8") as f:
            json.dump(all_items, f, ensure_ascii=False, indent=2)

        print("âœ” RSS æŠ“å–å®Œæˆï¼Œæ€»æ¡æ•°:", len(all_items))
        EOF

    # -----------------------
    # 4) æ’åº + ç¿»è¯‘ + æ¨é€é’‰é’‰
    # -----------------------
    - name: Send digest to DingTalk
      env:
        DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
      run: |
        python <<EOF
        import os, json, datetime, urllib.request
        from googletrans import Translator

        webhook = os.environ.get("DINGTALK_WEBHOOK")
        if not webhook or not webhook.startswith("http"):
            raise SystemExit("âŒ ERROR: DINGTALK_WEBHOOK æœªè®¾ç½®æˆ–æ ¼å¼é”™è¯¯")

        translator = Translator()

        # =====================================================
        #   ğŸ”¥ æƒé‡ä½“ç³»ï¼šå äº§å“è§„åˆ’ / æ–°å“ / æŠ€æœ¯è·¯çº¿
        # =====================================================

        # ğŸŸ¥ S çº§ï¼ˆæœ€é«˜ï¼‰ï¼šæ¥å£ / æ ‡å‡† / èŠ¯ç‰‡ / ä¾›ç”µ / Dock / Hub ç­‰â€œè·¯çº¿çº§â€ä¿¡æ¯
        S_keywords = [
            # æ¥å£ / æ ‡å‡†
            "usb4", "usb 4",
            "thunderbolt 5", "thunderbolt 4", "thunderbolt",
            "hdmi 2.1", "hdmi 2.1a",
            "hdmi 2.2", "hdmi2.2",
            "displayport 2.1", "dp 2.1",

            # ä¾›ç”µ / å……ç”µåè®®
            "gan charger", "65w charger", "100w charger", "140w charger", "240w",
            "pd 3.1", "power delivery",

            # Dock / Hub / è½¬æ¥
            "usb-c dock", "usb c dock", "type-c dock",
            "docking station", "dock",
            "usb-c hub", "type-c hub", "usbc hub", "hub",

            # æ€»çº¿ / å¸¦å®½
            "pcie 5.0", "pcie gen5", "pcie gen4",

            # æ— çº¿æ ‡å‡†
            "wi-fi 7", "wifi 7",
            "bluetooth 5.4", "ble audio",

            # èŠ¯ç‰‡ / è®¡ç®—
            "soc", "processor", "npu", "neural engine", "isp",

            # å…·ä½“èŠ¯ç‰‡å®¶æ—
            "snapdragon", "dimensity",
            "apple m3", "apple m4", "m3 pro", "m3 max",
            "ryzen", "core ultra", "meteor lake", "arrow lake", "lunar lake",

            # æ˜¾ç¤ºç›¸å…³é«˜ç«¯è¶‹åŠ¿
            "gaming monitor", "oled monitor",
            "mini-led", "miniled", "qled",
        ]

        # ğŸŸ§ A çº§ï¼šçº¿æ / å° 3C é…ä»¶ / å¤–è®¾ / å­˜å‚¨ ç­‰å¤–å›´ç”Ÿæ€
        A_keywords = [
            # çº¿æ & å……ç”µ
            "usb-c cable", "usbc cable", "type-c cable",
            "charging cable", "charging brick", "charger",
            "car charger", "car mount", "wireless charger",
            "power bank",

            # é…ä»¶ & å¤–è®¾
            "adapter",
            "mechanical keyboard", "macropad", "macro pad", "keypad",
            "mouse", "trackpad",
            "laptop stand", "monitor arm", "stand",

            # å­˜å‚¨
            "external ssd", "portable ssd", "nvme enclosure",
        ]

        # ğŸŸ¨ B çº§ï¼šæ¸¸æˆç¡¬ä»¶ / æŒæœºï¼ˆè¶‹åŠ¿é‡è¦ï¼Œä½†ä¸æ˜¯ä½ æ¯å¤©ä¸€å®šè¦çœ‹çš„ï¼‰
        B_keywords = [
            "steam deck", "rog ally", "legion go",
            "nintendo switch", "switch 2",
            "playstation 5", "ps5",
            "xbox series x", "xbox series s",
            "gaming handheld", "handheld gaming pc",
            "vr headset", "mixed reality", "apple vision pro",
        ]

        # ğŸŸ© C çº§ï¼šè½åœ¨ç»ˆç«¯ä¾§çš„ AI / è®¢é˜…å½¢æ€ï¼ˆå’Œäº§å“å½¢æ€æœ‰å…³å³å¯ï¼‰
        C_keywords = [
            "ai pc", "copilot+", "copilot plus", "on-device ai",
            "local ai", "edge ai",
            "large language model", "llm",
            "cloud gaming", "game pass",
            "subscription", "bundle",
        ]

        # ğŸš€ â€œæ–°å“æ„Ÿâ€åŠ æƒï¼šæ–°å“å‘å¸ƒ / å‡çº§ / é¦–å‘
        NEWNESS_WORDS = [
            "launches", "launch", "launched",
            "announces", "announce", "announced",
            "unveils", "unveil", "unveiled",
            "releases", "release", "released",
            "introduced", "introduces", "introduce",
            "new", "next-gen", "next generation",
            "refresh", "updated", "update",
        ]

        # ğŸ” è¯„æµ‹ / æ‹†è§£ / è§„æ ¼ï¼šå¯¹äº§å“è§„åˆ’ä¹Ÿå¾ˆæœ‰ä»·å€¼
        REVIEW_WORDS = [
            "review", "hands-on", "hands on",
            "first look", "impressions",
            "teardown", "inside",
            "benchmark", "benchmarks",
            "performance", "specs", "specifications",
        ]

        # ğŸ§± å™ªéŸ³ï¼šè£å‘˜ / è´¢æŠ¥ / è¯‰è®¼ / å¹¶è´­ï¼ˆæ›´å¤šæ˜¯â€œå…¬å¸å±‚é¢â€ï¼Œå¯¹é€‰å“ä»·å€¼ä½ï¼‰
        NOISE_WORDS = [
            "lawsuit", "sued", "trial",
            "regulation", "regulatory",
            "privacy policy",
            "earnings", "revenue", "q1", "q2", "q3", "q4",
            "stock", "share price", "ipo",
            "acquisition", "merger", "antitrust",
            "layoffs", "fired", "strike",
        ]

        # ğŸ“Œ å¹³å°ä¼˜å…ˆçº§å¾®è°ƒï¼šåè¯„æµ‹/ç¡¬ä»¶å‘ï¼Œå¯¹äº§å“è§„åˆ’å¾ˆæœ‰ç”¨
        HIGH_VALUE_PLATFORMS = [
            "Tomâ€™s Hardware", "Tom's Hardware",
            "GSM Arena", "Notebook Check",
            "The Verge", "Ars Technica",
        ]

        def calc_score(text, platform):
            t = text.lower()
            score = 0

            # æ­£å‘åŠ åˆ†
            score += sum(8 for k in S_keywords if k in t)
            score += sum(5 for k in A_keywords if k in t)
            score += sum(3 for k in B_keywords if k in t)
            score += sum(1 for k in C_keywords if k in t)

            # æ–°å“ / è¯„æµ‹ åŠ ä¸€ç‚¹é¢å¤–æƒé‡
            score += sum(1 for k in NEWNESS_WORDS if k in t)
            score += sum(1 for k in REVIEW_WORDS if k in t)

            # å™ªéŸ³å‡åˆ†
            score -= sum(3 for k in NOISE_WORDS if k in t)

            # é«˜ä»·å€¼å¹³å° +1 åŸºç¡€åˆ†
            if platform in HIGH_VALUE_PLATFORMS:
                score += 1

            return score

        # -----------------------
        # è¯»å– feeds.json
        # -----------------------
        with open("feeds.json", "r", encoding="utf-8") as f:
            items = json.load(f)

        # -----------------------
        # è®¡ç®—åˆ†æ•°æ’åº
        # -----------------------
        for item in items:
            text = (item.get("title", "") or "") + " " + (item.get("summary", "") or "")
            platform = item.get("platform", "")
            item["score"] = calc_score(text, platform)

        items_sorted = sorted(items, key=lambda x: x["score"], reverse=True)
        items_final = items_sorted[:20]

        # -----------------------
        # ç¿»è¯‘æ ‡é¢˜
        # -----------------------
        def to_zh(text):
            try:
                return translator.translate(text, dest="zh-cn").text
            except Exception:
                return text

        now = datetime.datetime.utcnow() + datetime.timedelta(hours=8)
        ts = now.strftime("%Y-%m-%d %H:%M")

        lines = []
        lines.append(f"### ğŸŒ çƒ­ç‚¹ç§‘æŠ€åª’ä½“æ—¥æŠ¥ï¼ˆ{ts}ï¼‰\\n")
        lines.append(f"å…±æŠ“å– {len(items)} æ¡ï¼Œå±•ç¤ºä¼˜å…ˆçº§æœ€é«˜çš„å‰ 20 æ¡\\n\\n")

        # -----------------------
        # Markdown è¶…é“¾æ¥è¾“å‡º
        # -----------------------
        for i, item in enumerate(items_final, 1):
            zh = to_zh(item.get("title", ""))
            url = item.get("url", "")
            platform = item.get("platform", "")
            lines.append(f"{i}. **[{platform}] [{zh}]({url})**\\n\\n")

        payload = {
            "msgtype": "markdown",
            "markdown": {
                "title": "çƒ­ç‚¹ç§‘æŠ€åª’ä½“æ—¥æŠ¥",
                "text": "".join(lines)
            }
        }

        req = urllib.request.Request(
            webhook,
            data=json.dumps(payload).encode(),
            headers={"Content-Type": "application/json"}
        )
        with urllib.request.urlopen(req) as resp:
            print("é’‰é’‰å“åº”:", resp.read().decode())
        EOF

    # -----------------------
    # 5) è‡ªåŠ¨ commit feeds.json
    # -----------------------
    - name: Commit updates
      run: |
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions"
        git add feeds.json
        git commit -m "Update RSS feeds" || echo "No changes"
        git push
