name: Update RSS Feeds

on:
  schedule:
    - cron: "0 */8 * * *"  # 每 8 小时自动运行一次（可改）
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install feedparser requests

      - name: Generate feeds.json
        run: |
          python <<EOF
          import feedparser
          import json

          # 你放在 feeds.json 的 RSS 列表
          with open("feeds.json", "r", encoding="utf-8") as f:
              feed_list = json.load(f)

          items = []
          for feed in feed_list:
              parsed = feedparser.parse(feed["url"])
              for entry in parsed.entries[:5]:  # 每源取 5 条
                  items.append({
                      "title": entry.title,
                      "link": entry.link
                  })

          # 保存结果
          with open("feeds_output.json", "w", encoding="utf-8") as f:
              json.dump(items, f, ensure_ascii=False, indent=2)
          EOF

      - name: Send digest to DingTalk
        env:
          DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}
        run: |
          python <<EOF
          import json
          import requests

          with open("feeds_output.json", "r", encoding="utf-8") as f:
              feeds = json.load(f)

          # ⚠ 必须包含你钉钉机器人的关键词：热点
          content = "【热点 RSS 日报】\n\n"
          
          for item in feeds[:15]:  # 最多发 15 条，避免消息太长
              content += f"- {item['title']}\n  {item['link']}\n\n"

          payload = {
              "msgtype": "text",
              "text": {"content": content}
          }

          r = requests.post("${DINGTALK_WEBHOOK_URL}", json=payload)
          print("DingTalk response:", r.text)
          EOF

      - name: Commit updates
      # 是否要把 feeds_output.json 推回仓库？如果不想保存可以删掉这个 step
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "actions@github.com"
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add .
            git commit -m "Update RSS feeds"
            git push
          fi
