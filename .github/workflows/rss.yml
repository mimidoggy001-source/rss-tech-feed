name: Update RSS Feeds

on:
  # æ¯å¤©åŒ—äº¬æ—¶é—´ 21:00 è‡ªåŠ¨æ¨é€ï¼ˆ13:00 UTCï¼‰
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    # -----------------------
    # 1) æ‹‰å–ä»“åº“
    # -----------------------
    - name: Checkout repo
      uses: actions/checkout@v3

    # -----------------------
    # 2) Python ç¯å¢ƒ
    # -----------------------
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        pip install feedparser requests googletrans==4.0.0-rc1

    # -----------------------
    # 3) æŠ“å– RSS
    # -----------------------
    - name: Fetch RSS & Generate feeds.json
      run: |
        python <<EOF
        import feedparser, json

        rss_sources = [
            # ==== æµ·å¤–ç§‘æŠ€åª’ä½“ ====
            ("TechCrunch", "https://techcrunch.com/feed/"),
            ("The Verge", "https://www.theverge.com/rss/index.xml"),
            ("Engadget", "https://www.engadget.com/rss.xml"),
            ("Wired", "https://www.wired.com/feed/rss"),
            ("Ars Technica", "https://feeds.arstechnica.com/arstechnica/index/"),
            ("Bloomberg Tech", "https://feeds.bloomberg.com/technology/news.rss"),

            # ==== æ¸¸æˆ / æŒæœº ====
            ("IGN", "https://www.ign.com/rss"),
            ("GameSpot", "https://www.gamespot.com/feeds/mashup/"),
            ("Eurogamer", "https://www.eurogamer.net/?format=rss"),
            ("Kotaku", "https://kotaku.com/rss"),

            # ==== æ¶ˆè´¹ç”µå­ / æ‰‹æœº ====
            ("GSM Arena", "https://www.gsmarena.com/rss-news-reviews.php"),
            ("Android Authority", "https://www.androidauthority.com/feed/"),
            ("Notebook Check", "https://www.notebookcheck.net/RSS-Feed.8156.0.html"),
            ("Tomâ€™s Hardware", "https://www.tomshardware.com/feeds/all"),

            # ==== å›½å†…ç§‘æŠ€ ====
            ("ITHome", "https://www.ithome.com/rss/"),
            ("SSPai", "https://sspai.com/feed"),
            ("Leiphone", "https://www.leiphone.com/feed"),
        ]

        all_items = []

        for name, url in rss_sources:
            try:
                feed = feedparser.parse(url)
                for entry in feed.entries[:20]:
                    all_items.append({
                        "title": entry.get("title", ""),
                        "summary": entry.get("summary", "")[:500],
                        "url": entry.get("link", ""),
                        "platform": name,
                    })
            except Exception as e:
                print("âš  RSS æŠ“å–å¤±è´¥:", name, url, e)

        with open("feeds.json", "w", encoding="utf-8") as f:
            json.dump(all_items, f, ensure_ascii=False, indent=2)

        print("âœ” RSS æŠ“å–å®Œæˆï¼Œæ€»æ¡æ•°:", len(all_items))
        EOF

    # -----------------------
    # 4) æ’åº + ç¿»è¯‘ + æ¨é€é’‰é’‰
    # -----------------------
    - name: Send digest to DingTalk
      env:
        DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
      run: |
        python <<EOF
        import os, json, datetime, urllib.request
        from googletrans import Translator

        webhook = os.environ.get("DINGTALK_WEBHOOK")
        if not webhook or not webhook.startswith("http"):
            raise SystemExit("âŒ ERROR: DINGTALK_WEBHOOK æœªè®¾ç½®æˆ–æ ¼å¼é”™è¯¯")

        translator = Translator()

        # =====================================================
        #   ğŸ”¥ æœ€æ–°æƒé‡ä½“ç³»ï¼ˆä¸¥æ ¼æ ¹æ®ä½ çš„è¦æ±‚ï¼‰
        # =====================================================

        # ğŸŸ¥ S çº§ï¼ˆæœ€é«˜ï¼‰ï¼šæ¶ˆè´¹ç”µå­ / æ‰‹æœº / å¹³æ¿ / æ˜¾ç¤ºå™¨ / ç¬”ç”µ / èŠ¯ç‰‡
        S_keywords = [
            "apple", "iphone", "ipad", "macbook", "airpods",
            "samsung", "galaxy",
            "google pixel", "pixel",
            "qualcomm", "snapdragon", "mediatek",
            "laptop", "notebook", "ultrabook",
            "tablet", "android", "windows",
            "monitor", "display",
            "usb-c", "charger", "bluetooth", "headphones",
        ]

        # ğŸŸ§ A çº§ï¼š3C ç”µå­è®¾å¤‡ / è®¡ç®—ç¡¬ä»¶
        A_keywords = [
            "ssd", "gpu", "rtx", "nvidia",
            "intel", "amd",
            "router", "wifi",
            "type-c hub", "dock", "accessories",
            "battery", "wireless", "camera",
        ]

        # ğŸŸ¨ B çº§ï¼šæ¸¸æˆè®¾å¤‡ï¼ˆæƒé‡é™ä½ï¼‰
        B_keywords = [
            "steam deck", "rog ally", "legion go",
            "nintendo switch", "switch 2",
            "playstation", "ps5",
            "xbox", "gaming handheld",
        ]

        # ğŸŸ© C çº§ï¼šæ³›ç§‘æŠ€ / AI
        C_keywords = [
            "ai", "artificial intelligence",
            "cloud", "robot", "tesla", "musk",
            "meta", "openai", "security",
        ]

        def calc_score(text):
            t = text.lower()
            score = 0
            score += sum(6 for k in S_keywords if k in t)
            score += sum(4 for k in A_keywords if k in t)
            score += sum(2 for k in B_keywords if k in t)
            score += sum(1 for k in C_keywords if k in t)
            return score

        # -----------------------
        # è¯»å– feeds.json
        # -----------------------
        with open("feeds.json", "r", encoding="utf-8") as f:
            items = json.load(f)

        # -----------------------
        # è®¡ç®—åˆ†æ•°æ’åº
        # -----------------------
        for item in items:
            item["score"] = calc_score(item["title"] + " " + item["summary"])

        items_sorted = sorted(items, key=lambda x: x["score"], reverse=True)
        items_final = items_sorted[:20]

        # -----------------------
        # ç¿»è¯‘æ ‡é¢˜
        # -----------------------
        def to_zh(text):
            try:
                return translator.translate(text, dest="zh-cn").text
            except:
                return text

        now = datetime.datetime.utcnow() + datetime.timedelta(hours=8)
        ts = now.strftime("%Y-%m-%d %H:%M")

        lines = []
        lines.append(f"### ğŸŒ çƒ­ç‚¹ç§‘æŠ€åª’ä½“æ—¥æŠ¥ï¼ˆ{ts}ï¼‰\\n")
        lines.append(f"å…±æŠ“å– {len(items)} æ¡ï¼Œå±•ç¤ºä¼˜å…ˆçº§æœ€é«˜çš„å‰ 20 æ¡\\n\\n")

        # -----------------------
        # é‡ç‚¹ï¼šMarkdown è¶…é“¾æ¥
        # -----------------------
        for i, item in enumerate(items_final, 1):
            zh = to_zh(item["title"])
            url = item["url"]
            platform = item["platform"]

            lines.append(f"{i}. **[{platform}] [{zh}]({url})**\\n\\n")

        payload = {
            "msgtype": "markdown",
            "markdown": {
                "title": "çƒ­ç‚¹ç§‘æŠ€åª’ä½“æ—¥æŠ¥",
                "text": "".join(lines)
            }
        }

        req = urllib.request.Request(
            webhook,
            data=json.dumps(payload).encode(),
            headers={"Content-Type": "application/json"}
        )
        with urllib.request.urlopen(req) as resp:
            print("é’‰é’‰å“åº”:", resp.read().decode())
        EOF

    # -----------------------
    # 5) è‡ªåŠ¨ commit feeds.json
    # -----------------------
    - name: Commit updates
      run: |
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions"
        git add feeds.json
        git commit -m "Update RSS feeds" || echo "No changes"
        git push
