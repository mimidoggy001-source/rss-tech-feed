name: Update RSS Feeds

on:
  # æ¯å¤© 21:00ï¼ˆ13:00 UTCï¼‰æ›´æ–°ä¸€æ¬¡ï¼Œå¦‚æœä½ æƒ³æ”¹é¢‘ç‡ï¼Œæ”¹è¿™ä¸€è¡Œ cron å³å¯
  schedule:
    - cron: "0 13 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install feedparser

      - name: Generate feeds.json
        run: |
          python <<EOF
          import feedparser, json

          rss_list = [
            ("TechCrunch", "https://techcrunch.com/feed/"),
            ("The Verge", "https://www.theverge.com/rss/index.xml"),
            ("Engadget", "https://www.engadget.com/rss.xml"),
            ("Wired", "https://www.wired.com/feed/rss"),
            ("Ars Technica", "https://feeds.arstechnica.com/arstechnica/index/"),
            ("Tom's Guide", "https://www.tomsguide.com/feeds/all"),
            ("Polygon", "https://www.polygon.com/rss/index.xml"),
            ("IGN", "https://www.ign.com/rss"),
            ("GameSpot", "https://www.gamespot.com/feeds/mashup/"),
            ("Bloomberg Tech", "https://feeds.bloomberg.com/technology/news.rss"),
            ("VentureBeat AI", "https://venturebeat.com/category/ai/feed/"),
            ("MIT Tech Review", "https://www.technologyreview.com/feed/")
          ]

          all_items = []

          for name, url in rss_list:
              feed = feedparser.parse(url)
              for e in feed.entries[:20]:
                  all_items.append({
                      "title": e.get("title", ""),
                      "url": e.get("link", ""),
                      "platform": name,
                      "published": e.get("published", ""),
                      "summary": e.get("summary", "")[:200]
                  })

          with open("feeds.json", "w", encoding="utf-8") as f:
              json.dump(all_items, f, ensure_ascii=False, indent=2)
          EOF

      - name: Send digest to DingTalk
        env:
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
        run: |
          python <<EOF
          import os, json, datetime, urllib.request

          webhook = os.environ.get("DINGTALK_WEBHOOK")
          if not webhook:
              raise SystemExit("DINGTALK_WEBHOOK æœªé…ç½®ï¼Œè¯·åœ¨ä»“åº“ Settings â†’ Secrets é‡Œæ·»åŠ ")

          # è¯»å–åˆšæ‰ç”Ÿæˆçš„ feeds.json
          with open("feeds.json", "r", encoding="utf-8") as f:
              data = json.load(f)

          # å–å‰ 15 æ¡ï¼Œé˜²æ­¢æ¶ˆæ¯å¤ªé•¿
          items = data[:15]

          # åŒ—äº¬æ—¶é—´
          now = datetime.datetime.utcnow() + datetime.timedelta(hours=8)
          ts = now.strftime("%Y-%m-%d %H:%M")

          lines = []
          lines.append(f"### ğŸŒ å…¨çƒç§‘æŠ€åª’ä½“æ—¥æŠ¥ï¼ˆ{ts} åŒ—äº¬æ—¶é—´ï¼‰\\n\\n")
          lines.append("- æ¥æºï¼šTechCrunch / The Verge / Engadget / Wired / IGN / Bloomberg ç­‰\\n")
          lines.append(f"- æœ¬æ¬¡æŠ“å–ï¼š{len(items)} æ¡\\n\\n")

          for i, item in enumerate(items, 1):
              title = (item.get("title") or "").replace("\\n", " ").strip()
              plat = item.get("platform") or "æœªçŸ¥æ¥æº"
              url = item.get("url") or ""
              lines.append(f"{i}. **[{plat}]** {title}\\n\\n    {url}\\n\\n")

          text = "".join(lines)

          # é’‰é’‰å•æ¡æ¶ˆæ¯é•¿åº¦æœ‰ä¸Šé™ï¼Œè¶…äº†å°±æˆªæ–­ä¸€ä¸‹
          if len(text) > 19000:
              text = text[:19000] + "\\n\\n...(å†…å®¹å·²æˆªæ–­)"

          payload = {
              "msgtype": "markdown",
              "markdown": {
                  "title": "å…¨çƒç§‘æŠ€åª’ä½“æ—¥æŠ¥",
                  "text": text
              }
          }

          data_bytes = json.dumps(payload).encode("utf-8")
          req = urllib.request.Request(
              webhook,
              data=data_bytes,
              headers={"Content-Type": "application/json"}
          )
          with urllib.request.urlopen(req) as resp:
              print("DingTalk response:", resp.read().decode("utf-8"))
          EOF

      - name: Commit updates
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add feeds.json
          git commit -m "Update RSS feeds" || echo "No changes"
          git push
